#!/bin/bash
#
# This script install the ClassAdmin software.
#

if [[ $(whoami) != "root" ]];then
        echo -e "\033[1;31m[-]\033[0m You aren't root"
        exit
fi

function operation(){
        function loading(){
                while [ true ]
                do
                        echo -ne "."
                        sleep 2
                done
        }
        echo -ne $1
        loading&
        PID_loading=$!
        # if the installation or uninstallation have dialogs, it doesn't show it, but is executed.
        if [[ $3 = 1 ]];then
                $2
                echo -ne "\033[1;32mOK\033[0m"
        else
                DEBIAN_FRONTEND=nointeractive $2 > /dev/null 2>&1
                echo -ne "\033[1;32mOK\033[0m"
        fi
        kill -19 $PID_loading > /dev/null 2>&1
        echo ""
}
echo -ne "Do you want install the ClassAdminS server or ClassAdmin client? [ClassAdmin/ClassAdminS]: "
read ask
if [[ $ask == "ClassAdmin" ]];then
        operation "updating repositories." "apt-get update -y"
        operation "Installing packages." "apt-get install -y python3 python3-pip git zenity scrot"
        operation "Deleting Django/ and init.sql." "rm -rf ./Django && shred -uz -n 5 ./init.sql && shred -uz -n 5 ./services/ClassAdminS.socket && shred -uz -n 5 ./Daemon/ClassAdminS.service"
        operation "Install python3 libraries." "pip3 install json hashlib base64 requests io random binascii math os sys platform pillow threading multiprocessing sockets plyer pyscreenshot datetime"
        operation "Adding environtment variables." "echo 'CLASSADMIN_HOME=/etc/ClassAdmin' >> /etc/environtment && echo 'CLASSADMIN_LOG=/var/log/ClassAdmin.log' >> /etc/environtment && echo 'CLASSADMIN_SSL=/etc/ClassAdmin/ssl' >> /etc/environtment && sed -i '/PYTHONPATH/d' /etc/environment && echo 'PYTHONPATH=/etc/ClassAdmin' >> /etc/environtment"
        operation "Installing ClassAdmin CA Bundle" "cp ./ssl/ClassAdmin.crt /usr/local/share/ca-certificates/ && update-ca-certificates"
        server=""
        while [[ $(echo $server | grep -E -o "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}") == "" ]];
        do
          echo -ne "Which is ClassAdminS server IP address?"
          read server
        done
        operation "adding dns in /etc/hosts" "echo '$server     classadmin.server' >> /etc/hosts"
        operation "Installing ClasAdmin service." "cp ./Daemon/ClassAdmin.service /lib/systemd/system && systemctl daemon-reload"
        notification=""
        while [[ $notification != "true" || $notification != "false" ]];
        do
          echo -ne "Do you want that ClassAdmin service send system notifications? [true/false]: "
          read notification
        done
        operation "Configurating notifications." "sed -i 's/\"notifications\": \"true\"/\"notifications\": \"$notification\"' ./services/ClassAdmin.conf"
        user=""
        while [[ $user == "" ]];
        do
          echo -ne "The notifications will be execute as user...: "
          read user
        done
        operation "Notifications will be execute as $user." "sed -i 's/\"user\":\"whoami\"/\"user\":\"$user\"' ./services/ClassAdmin.conf"
        operation "changing permissions for ClassAdmin proyect" "chmod o+w /var/log"
        operation "Creating ClassAdmin user" "adduser -p $(openssl passwd -1 12345678) --force-badname ClassAdmin"

        echo -e "\033[1;32m[+]\033[0m ClassAdmin installation completed"
else
        exit 1
fi